FROM tensorflow/tensorflow:1.12.0-gpu-py3 
RUN apt-get update
RUN pip install numpy
RUN pip install nltk 
RUN python -m nltk.downloader all
RUN apt-get install pkg-config zip zlib1g-dev unzip -y # For bazel installation

# A workspace directory will be created under /container/, which is our workspace for bazel
# All directories in 2_imageCaptionGenerator will be copied to /container/workspace/, except app
# /container/workspace will contains: im2txt, captionData and WORKSPACE
# The empty file WORKSPACE must be placed under the bazel workspace (named workspace here) so that bazel can build
# ADD imagequery/2_imageCaptionGenerator/conda-env /container/workspace/conda-env
# ADD imagequery/2_imageCaptionGenerator/g3doc /container/workspace/g3doc
ADD imagequery/2_imageCaptionGenerator/im2txt /container/workspace/im2txt
ADD imagequery/2_imageCaptionGenerator/WORKSPACE /container/workspace/
ADD imagequery/2_imageCaptionGenerator/captionData /container/workspace/captionData/

# 2_imageCaptionGenerator/app, bazel-installer and simplerpc/app will be copied to /container/
# RUN ["wget","https://github.com/bazelbuild/bazel/releases/download/0.25.1/bazel-0.25.1-installer-linux-x86_64.sh","-P","/container"]
ADD imagequery/2_imageCaptionGenerator/bazel-0.25.1-installer-linux-x86_64.sh /container/
ADD imagequery/2_imageCaptionGenerator/app /container/
ADD simplerpc/app /container/

###  Install bazel
RUN chmod +x /container/bazel-0.25.1-installer-linux-x86_64.sh
RUN /container/bazel-0.25.1-installer-linux-x86_64.sh 
RUN export PATH="$PATH:$HOME/bin"

RUN chmod 777 /container/workspace/im2txt/model/downloadModels.sh
RUN /container/workspace/im2txt/model/downloadModels.sh
RUN mv /notebooks/newmodel.ckpt-2000000.meta /container/workspace/im2txt/model
RUN mv /notebooks/newmodel.ckpt-2000000.data-00000-of-00001 /container/workspace/im2txt/model

RUN chmod 777 /container/workspace/im2txt/runWithArg.sh

CMD ["python","/container/predict.py"]

EXPOSE 9000
