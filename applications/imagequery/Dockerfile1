FROM linuxbrew/linuxbrew:latest

RUN apt-get update
RUN apt-get install python3 -y
RUN apt-get install python3-pip -y
RUN brew tap watsonbox/cmu-sphinx
RUN brew install --HEAD watsonbox/cmu-sphinx/cmu-sphinxbase
RUN brew install bison
RUN brew install --HEAD watsonbox/cmu-sphinx/cmu-pocketsphinx

# Dep
RUN apt-get install -y swig libpulse-dev libasound2-dev
RUN pip3 install pocketsphinx

###############################################################
RUN pip3 install grpcio
RUN pip3 install protobuf

# for downloading and renameing dataset3
RUN apt-get install curl -y
RUN apt-get install ffmpeg -y

# for pydub in truncate.py
RUN pip3 install pydub
RUN apt-get install ffmpeg libavcodec-extra -y

# for listing files in truncate.py
RUN pip3 install glob3


# container/ will have predict.py, data/
ADD imagequery/c1_speechRecognition/app /container/
ADD imagequery/c1_speechRecognition/data /container/data

# dataset1 
# dataset source: http://festvox.org/cmu_arctic/
RUN wget --progress=bar:force http://festvox.org/cmu_arctic/cmu_arctic/packed/cmu_us_awb_arctic-0.95-release.zip
RUN mv $(find / -name cmu_us_awb_arctic-0.95-release.zip) /container/data/dataset1
RUN chmod 777 /container/data/dataset1/unzipRename.sh
RUN /container/data/dataset1/unzipRename.sh

# dataset2
# reference: https://groups.csail.mit.edu/sls/downloads/flickraudio/index.cgi
# RUN wget --progress=bar:force https://groups.csail.mit.edu/sls/downloads/flickraudio/downloads/flickr_audio.tar.gz
# RUN mv $(find / -name flickr_audio.tar.gz) /container/data/dataset2
# RUN chmod 777 /container/data/dataset2/untarRename.sh 
# RUN /container/data/dataset2/untarRename.sh

# dataset3
# download reference: https://www.kaggle.com/general/6604
# dataset refernce: https://www.kaggle.com/rtatman/speech-accent-archive/
# RUN chmod 777 /container/data/dataset3/downloadDataset.sh
# RUN /container/data/dataset3/downloadDataset.sh
# RUN mv $(find / -name speech-accent-archive.zip) /container/data/dataset3
# RUN unzip /container/data/dataset3/speech-accent-archive.zip -d /container/data/dataset3
# /container/data/dataset3 now contains:reading-passage.txt, recordings.zip, speakers_all.csv
# RUN unzip -qq /container/data/dataset3/recordings.zip -d /container/data/dataset3/
# RUN chmod 777 /container/data/dataset3/rename.sh
# RUN /container/data/dataset3/rename.sh
# RUN python3 /container/data/dataset3/truncate.py

ADD grpc/app/container_entry.sh /container/
ADD grpc/app/server.py /container/
ADD grpc/app/model_pb2_grpc.py /container/
ADD grpc/app/model_pb2.py /container/
ADD grpc/app/proxy_pb2_grpc.py /container/
ADD grpc/app/proxy_pb2.py /container/

WORKDIR /container

CMD ["python3", "/container/predict.py"]
# CMD ["/container/container_entry.sh", "c1", "/container/server.py"]

EXPOSE 8000